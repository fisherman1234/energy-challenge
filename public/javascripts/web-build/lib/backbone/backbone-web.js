define(["underscore","backbone","types"],function(e,t,n){var r=t.Model.extend({get:function(e){return this.toJSON()[e]},getSchema:function(){return e.isFunction(this.schema)?this.schema():this.schema},isValid:function(e){return e?!this.checkType(this.getSchema()[e].type,this.attributes[e]):t.Model.prototype.isValid.apply(this)},isExistingFieldsValid:function(){var t,n=this;return e.detect(e.keys(this.attributes),function(e){return!n.isValid(e)},function(e){t=e===undefined?!0:!1}),t},validate:function(t){if(this.getSchema()===undefined)return!1;var n=[];e.each(this.getSchema(),function(r,i){var s=t[i];if(s===undefined&&r.optional===!0)return;s===undefined&&e.has(r,"defaults")&&(s=e.isFunction(r.defaults)?r.defaults():r.defaults);var o=this.checkType(r.type,s);o&&n.push({error:o,column:i,value:s})},this);if(!n.length)return!1;return n;var r},checkType:function(e,t){if(!n.hasOwnProperty(e))return new Error("Invalid data type");if(!n[e].checkType)return!1;var r=n[e].checkType(t)._errors;return r.length?r.shift():!1},getSchemaDefaults:function(){var t={};return e.each(this.getSchema(),function(n,r){if(!e.has(n,"defaults"))return;t[r]=e.isFunction(n.defaults)?n.defaults():n.defaults}),t},toJSON:function(n){n=n||{},n.defaults=n.defaults===undefined?!0:!1;var r=t.Model.prototype.toJSON.apply(this),i=this;return e.each(e.keys(r),function(e,t){if(!i.getSchema().hasOwnProperty(e)){delete r[e];return}r[e]===undefined&&(r[e]=null)}),n.defaults&&(r=e.extend(this.getSchemaDefaults(),r)),r},parse:function(t){var n=this;t=t.data;if(!t)return{};var r={};return e.each(t,function(e,i){var s=n.getSchema();if(!s[i])return;r[i]=n.castType(s[i].type,t[i])}),r},castType:function(e,t){return n.hasOwnProperty(e)?n[e].sanitize?n[e].sanitize(t):t:new Error("Invalid data type")},url:function(){var t=e.result(this,"urlRoot")||e.result(this.collection,"url")||urlError();return this.isNew()?t+".json":t+(t.charAt(t.length-1)=="/"?"":"/")+encodeURIComponent(this.id)+".json"}});return r});